<!DOCTYPE html>
<html lang="ko" xmlns:th=http://www.thymeleaf.org
	xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout">
<head>
<meta charset="UTF-8">

<title>Minihompy</title>

<style>
#modDiv {   width: 300px;   height: 100px;  background-color: gray; position: absolute;
    top: 50%;   left: 50%;  margin-top: -50px;  margin-left: -150px;
    padding: 10px;  z-index: 1000;}
.pagination {  width: 100%;}
.pagination li{
  list-style: none;  float: left;
  padding: 3px;   border: 1px solid blue;  margin:3px;  
}
.pagination li a{  margin: 3px;  text-decoration: none;  }
</style>

</head>
<body>
<!-- jQuery 2.1.4 -->
<script src="http://code.jquery.com/jquery-2.2.3.min.js"> </script>
	<table>
		<caption>게시물 상세보기</caption>
		<tr>
			<th>글번호</th>
			<td th:text="${boardDTO.bno}" />
		</tr>
		<tr>
			<th>제목</th>
			<td th:text="${boardDTO.title}" />
		</tr>
		<tr>
			<th>이름</th>
			<td th:text="${boardDTO.name}" />
		</tr>
		<tr>
			<th>내용</th>
			<td th:text="${boardDTO.content}" />
		</tr>
		<tr>
			<th>작성일</th>
			<td
				th:text="${#calendars.format(boardDTO.regdate, 'yyyy-MM-dd HH:mm:ss')}" />
		</tr>
		<tr>
			<th>조회수</th>
			<td th:text="${boardDTO.readcount}" />
		</tr>
	</table>
	<br />
	<a th:href="@{update(bno=${boardDTO.bno})}" th:text="수정" /> |
	<a th:href="@{delete(bno=${boardDTO.bno})}" th:text="삭제" /> |
	<a th:href="@{list}" th:text="리스트" />
	
	<!-- 모달 부분 시작 -->
    <div id='modDiv' style="display: none;">
        <div class='modal-title'></div>
        <div>
            <input type='text' id='replytext'>
        </div>
        <div>
            <button type="button" id="replyModBtn">Modify</button>
            <button type="button" id="replyDelBtn">DELETE</button>
            <button type="button" id="closeBtn">Close</button>
        </div>
    </div>
	<!-- 모달 부분 시작 끝-->
 
    <h2>댓글 창</h2>
    <div>
        <div>
            REPLYER <input type='text' name='replyer' id='newReplyWriter'>
        </div>
        <div>
            REPLY TEXT <input type='text' name='replytext' id='newReplyText'>
        </div>
        <button id="replyAddBtn">ADD REPLY</button>
    </div>
 
	<!-- 댓글이 추가되는 부분 -->
    <ul id="replies">
    </ul>
	<!-- 댓글이 추가되는 부분 끝-->
	 
	<ul class='pagination'> </ul>
	
	<!-- 댓글 관련 스크립트 -->
	<script th:inline="javascript">
		  var bno = [[${boardDTO.bno}]]; // 기본값
		  getAllList(); // 페이지 시작 시 함수 호출
		  
		  // 댓글 리스트 가져오기
		  function getAllList() {
			$.getJSON("/replies/list/" + bno,
			function(data) {
				console.log(data);
				var str = "";
				var rd, date;
				$(data).each(
				function() {
					rd = new Date(this.regdate);
					date = rd.getFullYear() + "년 " + (rd.getMonth()+1) + "월 " + rd.getDate() + "일 " + rd.getHours() + "시 " + rd.getMinutes() + "분 " + rd.getSeconds() + "초 " +  '일월화수목금토'.charAt(rd.getUTCDay())+'요일';
					str += "<li data-rno='"+this.rno+"' class='replyLi'>"
						+ this.replyer + " : " + "<div class='replyDiv'>" + this.replytext + "</div>" + " " + date
						+ " <button>MOD</button></li>";
				});
				console.log(str);
				$("#replies").html(str);
			});
			
			$("#newReplyWriter").val('');
			$("#newReplyText").val('');
		  }
		  
		  // 댓글 추가
		  $("#replyAddBtn").on("click", function() {
			  var replyer = $("#newReplyWriter").val();
			  var replytext = $("#newReplyText").val();
			  $.ajax({
				  type : 'post',
				  url : '/replies',
				  headers : {
					  "Content-Type" : "application/json",
					  "X-HTTP-Method-Override" : "POST"
				  },
				  dataType : 'text',
				  data : JSON.stringify({
					  bno : bno,
					  replyer : replyer,
					  replytext : replytext
				  }),
				  success : function(result) {
					  console.log(result);
					  if (result == 'SUCCESS') {
						  alert("등록되었습니다.");
						  getAllList();
					  }
				  }
			  });
		  })
		  
		  // 댓글 수정
		  $("#replies").on("click", ".replyLi button", function() {
			  var reply = $(this).parent();
			  var rno = reply.attr("data-rno");
			  var replytext = reply.children('div').text();
			  $(".modal-title").html(rno);
			  $("#replytext").val(replytext);
			  $("#modDiv").show("slow");
		  })
		  
		  $("#replyModBtn").on("click", function() {
			  var rno = $(".modal-title").html();
			  var replytext = $("#replytext").val();
			  $.ajax({
				  type : 'put',
				  url : '/replies/' + rno,
				  headers : {
					  "Content-Type" : "application/json",
					  "X-HTTP-Method-Override" : "PUT"
				  },
				  dataType : 'text',
				  data : JSON.stringify({
					  replytext : replytext
				  }),
				  success : function(result) {
					  console.log(result);
					  if (result == 'SUCCESS') {
						  alert("수정되었습니다.");
						  $("#modDiv").hide("slow");
						  getAllList();
					  }
				  }
			  });
		  })
		  
		  
		  // 댓글 삭제
		  $("#replyDelBtn").on("click", function() {
			  var rno = $(".modal-title").html();
			  var replytext = $("#replytext").val();
			  $.ajax({
				  type : 'delete',
				  url : '/replies/' + rno,
				  headers : {
					  "Content-Type" : "application/json",
					  "X-HTTP-Method-Override" : "DELETE"
				  },
				  dataType : 'text',
				  success : function(result) {
					  console.log(result);
					  if (result == 'SUCCESS') {
						  alert("삭제되었습니다.");
						  $("#modDiv").hide("slow");
						  getAllList();
					  }
				  }
			  });
		  })
		  
		  $("#closeBtn").on("click", function() {
			  $("#modDiv").hide("slow");
		  });
		  
		           
	</script>
 
</body>
</html>
